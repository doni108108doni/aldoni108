{
  "spec": {
    "title": "Viewport Capture",
    "url": "https://www.w3.org/TR/mediacapture-viewport/"
  },
  "algorithms": [
    {
      "name": "MediaDevices/getViewportMedia()",
      "href": "https://www.w3.org/TR/mediacapture-viewport/#dom-mediadevices-getviewportmedia",
      "html": "When the <a data-link-type=\"idl\" data-lt=\"getViewportMedia()\" href=\"https://www.w3.org/TR/mediacapture-viewport/#dom-mediadevices-getviewportmedia\" class=\"internalDFN\" id=\"ref-for-dom-mediadevices-getviewportmedia-3\"><code>getViewportMedia</code></a><code>()</code>\n            method is called, the user agent <em class=\"rfc2119\">MUST</em> run the following\n            steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If the <a data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-settings-object\">current settings object</a>'s\n                <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-cross-origin-isolated-capability\">cross-origin isolated capability</a>\n                is false, return a promise <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a>\n                with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a>\n                attribute has the value <a data-link-type=\"idl\" data-lt=\"SecurityError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#securityerror\"><code>SecurityError</code></a>.</p>"
        },
        {
          "html": "If the <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window\">associated <code>Document</code></a>'s\n                <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context\">top-level browsing context</a>'s\n                <a href=\"https://wicg.github.io/document-policy/#required-document-policy\">\n                required document policy</a> does not contain\n                <code>Require-Document-Policy: viewport-capture</code> and\n                <code>Document-Policy: viewport-capture</code> (TODO: use correct algorithm),\n                return a promise <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a>\n                with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a>\n                attribute has the value <a data-link-type=\"idl\" data-lt=\"SecurityError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#securityerror\"><code>SecurityError</code></a>.<p></p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a> of <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\">this</a> does not have\n          <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation\">transient activation</a>, return a promise <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a>\n                with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a>\n                attribute has the value <a data-link-type=\"idl\" data-lt=\"InvalidStateError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\"><code>InvalidStateError</code></a>.</p>"
        },
        {
          "html": "<p>Let <var>constraints</var> be the method's first\n                argument.</p>"
        },
        {
          "html": "<p>If <code>constraints.video</code> is <code>false</code>,\n                  return a promise <a data-link-type=\"dfn\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a newly\n                  <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\">created</a> <a data-link-type=\"idl\" data-lt=\"TypeError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\"><code>TypeError</code></a>.</p>"
        },
        {
          "html": "For each <a data-link-type=\"dfn\" data-lt=\"exist\" data-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\">existing</a> member\n                in <var>constraints</var> whose value, <var>CS</var>, is\n                a dictionary, run the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>CS</var> contains a member named <code>advanced</code>,\n                    return a promise <a data-link-type=\"dfn\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a newly\n                    <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\">created</a> <a data-link-type=\"idl\" data-lt=\"TypeError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\"><code>TypeError</code></a>.</p>"
            },
            {
              "html": "<p>If <var>CS</var> contains a member whose name specifies a\n                    constrainable property applicable to\n                    <a href=\"https://www.w3.org/TR/screen-capture/#dfn-display-surface\">display surface</a>s,\n                    and whose value in turn is a dictionary containing a member\n                    named either <code>min</code> or <code>exact</code>, return\n                    a promise <a data-link-type=\"dfn\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a newly\n                    <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-create-exception\">created</a> <a data-link-type=\"idl\" data-lt=\"TypeError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\"><code>TypeError</code></a>.</p>"
            },
            {
              "html": "<p>If <var>CS</var> contains a member whose name specifies a\n                    constrainable property applicable to\n                    <a href=\"https://www.w3.org/TR/screen-capture/#dfn-display-surface\">display surface</a>s,\n                    and whose value in turn is a dictionary containing a member\n                    named <code>max</code>, and that member's value in turn is\n                    less than the constrainable property's\n                    <a href=\"https://www.w3.org/TR/screen-capture/#dfn-floor-value\">floor value</a>,\n                    then let <var>failedConstraint</var> be the name of the\n                    member, let <var>message</var> be either\n                    <code>undefined</code> or an informative human-readable\n                    message, and return a promise <a data-link-type=\"dfn\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a new\n                    <code>OverconstrainedError</code> created by calling\n                    <code>OverconstrainedError(<var>failedConstraint</var>,\n                    <var>message</var>)</code>.\n                  </p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>requestedMediaTypes</var> be the set of media\n                types in <var>constraints</var> with either a dictionary\n                value or a value of <code>true</code>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window\">associated <code>Document</code></a>\n                is NOT <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#fully-active\">fully active</a> or does NOT\n                <a href=\"https://html.spec.whatwg.org/multipage/#gains-focus\">have focus</a>, return\n                  a promise <a data-link-type=\"dfn\" data-lt=\"reject\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">rejected</a> with a\n                  <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                  <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value\n                  <a data-link-type=\"idl\" data-lt=\"InvalidStateError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\"><code>InvalidStateError</code></a>.</p>"
        },
        {
          "html": "<p>Let <var>p</var> be a new promise.</p>"
        },
        {
          "html": "Run the following steps in parallel:",
          "rationale": "for",
          "steps": [
            {
              "html": "For each media type <var>T</var> in\n                    <var>requestedMediaTypes</var>,",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If no sources of type <var>T</var> are available,\n                        <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>p</var> with a new\n                        <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                        <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value\n                        <a data-link-type=\"idl\" data-lt=\"NotFoundError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notfounderror\"><code>NotFoundError</code></a>.</p>"
                },
                {
                  "html": "<p>Read the current <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://www.w3.org/TR/permissions/#dfn-state\">permission state</a> for obtaining\n                        sources of type <var>T</var> in the current browsing\n                        context. If the permission state is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-denied\"><code>denied</code></a>\", jump to\n                        the step labeled <em>PermissionFailure</em> below.</p>"
                }
              ]
            },
            {
              "html": "<p>Optionally, e.g., based on a previously-established\n                    user preference, for security reasons, or due to platform\n                    limitations, jump to the step labeled <em>Permission Failure</em> below.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://www.w3.org/TR/permissions/#dfn-request-permission-to-use\">Request permission to use</a>\n                    viewport capture, for a <a data-link-type=\"idl\" data-lt=\"PermissionDescriptor\" data-type=\"dictionary\" href=\"https://www.w3.org/TR/permissions/#dom-permissiondescriptor\"><code>PermissionDescriptor</code></a> with its\n                    <a data-link-type=\"idl\" data-type=\"dict-member\" href=\"https://www.w3.org/TR/permissions/#dom-permissiondescriptor-name\"><code>name</code></a> set to <a href=\"https://www.w3.org/TR/mediacapture-viewport/#dfn-viewport-capture\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-viewport-capture-1\"><code>\"viewport-capture\"</code></a>, resulting in\n                    a set of provided media.</p>\n                    <p>The provided media <em class=\"rfc2119\">MUST</em> include precisely one video track, which\n                    <em class=\"rfc2119\">MUST</em> be a live-capture of the\n                    <a href=\"https://www.w3.org/TR/screen-capture/#dfn-browser\">browser</a>\n                    <a href=\"https://www.w3.org/TR/screen-capture/#dfn-display-surface\">display surface</a>\n                    of the <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window\">associated <code>Document</code></a>'s\n                    <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context\">top-level browsing context</a>'s\n                    <a href=\"https://html.spec.whatwg.org/multipage/#viewport\">viewport</a>.</p>\n                    <p>The provided media <em class=\"rfc2119\">MUST</em> include at most one audio track, which, if\n                    provided, <em class=\"rfc2119\">MUST</em> be the combined audio produced by the sum of\n                    documents that consist of the\n                    <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window\">associated <code>Document</code></a>'s\n                    <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context\">top-level browsing context</a>'s <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-document\">active document</a>, and\n                    all <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#active-document\">active document</a>s in <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#nested-browsing-context\">nested browsing context</a>s of\n                    the <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>'s <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window\">associated <code>Document</code></a>'s\n                    <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#top-level-browsing-context\">top-level browsing context</a>. This audio track\n                    <em class=\"rfc2119\">MUST NOT</em> be included if audio was not specified in\n                    <var>requestedMediaTypes</var>, or if it was specified as\n                    <code>false</code>.</p>\n                    <p>The source of a <a data-link-type=\"idl\" data-lt=\"MediaStreamTrack\" data-type=\"interface\" href=\"https://www.w3.org/TR/mediacapture-streams/#dom-mediastreamtrack\"><code>MediaStreamTrack</code></a> <em class=\"rfc2119\">MUST NOT</em> change.</p>\n                    <p>If the result of the request is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-granted\"><code>granted</code></a>\", then for\n                    each device that is sourcing the provided media, using\n                    a stable and private id for the device, <var>deviceId</var>,\n                    set [[devicesLiveMap]]<var>[deviceId]</var> to\n                    <code>true</code>, if it isn’t already <code>true</code>,\n                    and set the\n                    [[devicesAccessibleMap]]<var>[deviceId]</var> to\n                    <code>true</code>, if it isn’t already\n                    <code>true</code>.</p>\n                    <p>The user agent <em class=\"rfc2119\">MUST NOT</em>\n                    store a \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-granted\"><code>granted</code></a>\" permission entry.\n                    </p>\n                    <p>If the result is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-denied\"><code>denied</code></a>\", jump to the step labeled\n                    <em>Permission Failure</em> below. If the user never\n                    responds, this algorithm stalls on this step.</p>\n                    <p>If the user grants permission but a hardware error\n                    such as an OS/program/webpage lock prevents access,\n                    <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>p</var> with a new\n                    <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> object whose\n                    <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the value\n                    <a data-link-type=\"idl\" data-lt=\"NotReadableError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notreadableerror\"><code>NotReadableError</code></a> and abort these steps.</p>\n                    <p>If the result is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-granted\"><code>granted</code></a>\" but device access fails for\n                    any reason other than those listed above, <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a>\n                    <var>p</var> with a new <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a>\n                    object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the\n                    value <a data-link-type=\"idl\" data-lt=\"AbortError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#aborterror\"><code>AbortError</code></a> and abort these steps.</p>"
            },
            {
              "html": "<p>Let <var>stream</var> be the\n                    <a data-link-type=\"idl\" data-lt=\"MediaStream\" data-type=\"interface\" href=\"https://www.w3.org/TR/mediacapture-streams/#dom-mediastream\"><code>MediaStream</code></a> object for which the user\n                    granted permission.</p>"
            },
            {
              "html": "<p>Run the <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://www.w3.org/TR/mediacapture-streams/#dfn-applyconstraints-algorithm\">ApplyConstraints algorithm</a> on all\n                    tracks in <var>stream</var> with the appropriate\n                    constraints. Should this fail, let <var>failedConstraint</var>\n                    be the result of the algorithm that failed, and let\n                    <var>message</var> be either <code>undefined</code> or an\n                    informative human-readable message, and then <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a>\n                    <var>p</var> with a new <code>OverconstrainedError</code>\n                    created by calling\n                    <code>OverconstrainedError(<var>failedConstraint</var>,\n                    <var>message</var>)</code>.</p>"
            },
            {
              "html": "<p><a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\">Resolve</a> <var>p</var> with <var>stream</var> and\n                    abort these steps.</p>"
            },
            {
              "html": "<p><em>Permission Failure</em>: <a data-link-type=\"dfn\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">Reject</a>\n                    <var>p</var> with a new <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a>\n                    object whose <a data-link-type=\"idl\" data-type=\"attribute\" href=\"https://webidl.spec.whatwg.org/#dom-domexception-name\"><code>name</code></a> attribute has the\n                    value <a data-link-type=\"idl\" data-lt=\"NotAllowedError\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notallowederror\"><code>NotAllowedError</code></a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>p</var>.</p>"
        }
      ]
    }
  ]
}